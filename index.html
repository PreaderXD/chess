<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Chess</title>
    <style>
        /* Basic styles for the chessboard */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            margin: 20px auto;
            border: 2px solid #000;
            width: 480px;
            height: 480px;
        }

        .square {
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .square:nth-child(odd) {
            background-color: #f0d9b5;
        }

        .square:nth-child(even) {
            background-color: #b58863;
        }

        .selected {
            background-color: #f00;
        }

        .player-info {
            margin-top: 20px;
        }

        .turn-indicator {
            font-weight: bold;
        }

        .promo-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .promo-btn {
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="login-container">
        <button id="login-btn">Login with Google</button>
    </div>

    <div id="game-container" style="display: none;">
        <div id="board"></div>
        <div class="player-info">
            <div id="turn-indicator">White's Turn</div>
        </div>
        <div id="promo-container" style="display: none;">
            <div class="promo-btns">
                <button class="promo-btn" id="promote-queen">Queen</button>
                <button class="promo-btn" id="promote-knight">Knight</button>
                <button class="promo-btn" id="promote-rook">Rook</button>
                <button class="promo-btn" id="promote-bishop">Bishop</button>
            </div>
        </div>
    </div>

    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAiLcMdhdrXHQTv6NA8G1O28xKqi2PxQes",
            authDomain: "chess-5d5cd.firebaseapp.com",
            projectId: "chess-5d5cd",
            storageBucket: "chess-5d5cd.firebasestorage.app",
            messagingSenderId: "76245448485",
            appId: "1:76245448485:web:0955d7941fc81ae6254ccc",
            measurementId: "G-0EQ73HWZV7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let playerName = '';
        let gameId = '';
        let selectedPiece = null;

        // Board and piece representation
        const initialBoard = [
            ['♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖'],
            ['♙', '♙', '♙', '♙', '♙', '♙', '♙', '♙'],
            ['', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', ''],
            ['♟', '♟', '♟', '♟', '♟', '♟', '♟', '♟'],
            ['♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖']
        ];

        // Initialize game UI
        function initializeBoard() {
            const boardDiv = document.getElementById("board");
            boardDiv.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.classList.add('square');
                    square.dataset.row = row;
                    square.dataset.col = col;
                    square.innerHTML = initialBoard[row][col];
                    square.addEventListener('click', onSquareClick);
                    boardDiv.appendChild(square);
                }
            }
        }

        // Handle login
        document.getElementById("login-btn").addEventListener("click", () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    playerName = result.user.displayName;
                    document.getElementById("login-container").style.display = "none";
                    document.getElementById("game-container").style.display = "block";
                    startGame();
                })
                .catch((error) => {
                    console.error("Error during login:", error);
                });
        });

        // Start a new game
        function startGame() {
            gameId = createNewGame(playerName);
            listenToGame(gameId);
        }

        // Create a new game in Firebase
        function createNewGame(playerName) {
            const gameRef = ref(database, 'games').push();
            const gameId = gameRef.key;

            set(gameRef, {
                whitePlayer: playerName,
                blackPlayer: "",
                currentPlayer: "white",
                boardState: initialBoard,
                movesHistory: []
            });

            return gameId;
        }

        // Join an existing game
        function joinGame(gameId, playerName) {
            const gameRef = ref(database, "games/" + gameId);
            update(gameRef, {
                blackPlayer: playerName
            });
        }

        // Listen to game state changes
        function listenToGame(gameId) {
            const gameRef = ref(database, "games/" + gameId);

            onValue(gameRef, (snapshot) => {
                const gameData = snapshot.val();
                if (gameData) {
                    updateBoard(gameData.boardState);
                    updateGameInfo(gameData);
                }
            });
        }

        // Update board based on game state
        function updateBoard(boardState) {
            const boardDiv = document.getElementById("board");
            const squares = boardDiv.getElementsByClassName('square');

            let index = 0;
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    squares[index].innerHTML = boardState[row][col];
                    index++;
                }
            }
        }

        // Update turn indicator and other game info
        function updateGameInfo(gameData) {
            const currentPlayer = gameData.currentPlayer;
            document.getElementById("turn-indicator").innerText = `${currentPlayer.charAt(0).toUpperCase() + currentPlayer.slice(1)}'s Turn`;
        }

        // Handle square click (select piece or move)
        function onSquareClick(event) {
            const square = event.target;
            const row = parseInt(square.dataset.row);
            const col = parseInt(square.dataset.col);

            if (selectedPiece) {
                makeMove(selectedPiece.row, selectedPiece.col, row, col);
                selectedPiece = null;
            } else {
                selectedPiece = { row, col };
                square.classList.add("selected");
            }
        }

        // Make a move in the game
        function makeMove(fromRow, fromCol, toRow, toCol) {
            const gameRef = ref(database, "games/" + gameId);
            get(gameRef).then((snapshot) => {
                const gameData = snapshot.val();
                if (gameData) {
                    const boardState = gameData.boardState;
                    const piece = boardState[fromRow][fromCol];

                    boardState[toRow][toCol] = piece;
                    boardState[fromRow][fromCol] = "";

                    update(gameRef, {
                        boardState: boardState,
                        currentPlayer: gameData.currentPlayer === "white" ? "black" : "white"
                    });
                }
            });
        }

        // Initialize the board when the page loads
        window.onload = initializeBoard;
    </script>
</body>
</html>
